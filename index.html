<!DOCTYPE html>
<html lang="en">
<head>
  <title> Dedukti </title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" type="image/png" href="ressources/favicon.png"/>
  
  <!-- Leaflet and Bootstrap: CSS style -->
  <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/fontawesome.min.css"> -->
  <link rel="stylesheet" href="ressources/fontawesome.min.css">
  
  <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous"> -->
  <link rel="stylesheet" href="ressources/bootstrap.min.css">

  <style> foo { background: black; } </style>
</head>
<body>


<div class="container">
  <button class="" onclick="process_all_instructions();">Type Check !</button>
  <div class="row align-items-start">
    <div class="col mx-3">
      <h1>Code</h1>
      <div class="form-outline mx-3">
<textarea class="form-control" id="code" rows="30">
#REQUIRE test;

// Declarations
T : Type;
A : T -> Type;
B : t:T -> A t -> Type;
t : T;
a : A t;
b : B t a;

// Definitions
f : T -> T := x => x; 

// Custom rewrite rules
g : t:T -> a:A t -> B t a;
: g X a --> X;
: g * (x=>X[x]) --> X[a];

// Basic commands
#PRINT A;
#INFER x:T => T;
#EVAL (x=>x) (y=>y) (z=>T);
#CHECK T : Type;
</textarea>
      </div>
    </div>
    <div class="col mx-3">
      <h1>Ouput</h1>
      <div class="mx-3" id="logs"></div>
    </div>


  <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script> -->
<script src="ressources/bootstrap.bundle.min.js"></script>
<script src="lib/term.js"></script>
<script src="lib/context.js"></script>
<script src="lib/env.js"></script>
<script src="lib/dtree.js"></script>
<script src="lib/red.js"></script>
<script src="moo/moo.js"></script>
<script src="lib/grammar.js"></script>
<script src="nearley/lib/nearley.js"></script>
<script src="lib/pp.js"></script>
<script src="main.js"></script>
<script>

// Logs handling
const logs = document.getElementById("logs");
function clear_logs() { logs.innerHTML = ""; }
function log_ok(title,msg)   { log(title,msg,['alert','alert-success']); }
function log_info(title,msg) { log(title,msg,['alert','alert-info']); }
function log_warn(title,msg) { log(title,msg,['alert','alert-warning']); }
function log_err(err)  {
  const msg = err.message || err;
  const i = msg && msg.indexOf(':');
  if (msg.startsWith("Syntax error ")) {
    log('SYNTAX ERROR: '+msg.slice(13,i), msg.slice(i+1), ['alert','alert-danger']);
  } else {
    if (i >= 0) { log('ERROR: '+msg.slice(0,i), msg.slice(i+1), ['alert','alert-danger']); }
    else        { log('ERROR'                 , err           , ['alert','alert-danger']); }
  }
}
function log(title,msg,classes=[]) {
  const div = document.createElement('div');
  div.style['white-space']= 'pre-wrap';
  div.innerHTML = '<strong>['+title+']</strong> '+msg;
  div.classList.add('p-1');
  div.classList.add('m-2');
  classes.forEach((x)=>div.classList.add(x));
  logs.appendChild(div);
}

// Create a Parser object from our grammar.
const parser = new nearley.Parser(nearley.Grammar.fromCompiled(grammar));
const initial_state = parser.save();

// Converts a string to a series of instructions
function parse(code) {
  parser.restore(initial_state);
  parser.feed(code);
  return parser.results[0];
}


// Global variables for easy access
var code, instructions, env ,red;
var debug = true;

// Main processing loop
function process_all_instructions() {
  clear_logs();
  try {
    // Parsing of raw text code
    code = document.getElementById("code").value;
    instructions = parse( code );
    log_ok("Parsing","done.");
    // Reseting the environnement
    env = Env();
    red = Red();
    instructions.forEach((ins)=>process_instruction(ins,env,red));
    log_ok("All done !","");
  } catch(e) {
    log_err(e);
    if (debug) { throw e; }
  }
}

</script>